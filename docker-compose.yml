version: "3.8"

services:
  geth-node1:
    image: ethereum/client-go:v1.13.15
    networks:
      - geth-overlay
    ports:
      - "30311:30303/tcp"
      - "30311:30303/udp"
    volumes:
      - /home/vw-srv-0001/services/blockchain/node1/data:/root/.ethereum
      - /home/vw-srv-0001/services/blockchain/node1/password.txt:/root/password.txt:ro
      - /home/vw-srv-0001/services/blockchain/node1/config.toml:/root/config.toml:ro
    command:
      - "--config=/root/config.toml"
      - "--networkid=1234567"
      - "--syncmode=full"
      - "--gcmode=archive"
      - "--port=30303"
      - "--unlock=0xd545dcc1e15cd1f33ede6bf2b251b7b7b1094131"
      - "--password=/root/password.txt"
      - "--mine"
      - "--miner.etherbase=0xd545dcc1e15cd1f33ede6bf2b251b7b7b1094131"
      - "--allow-insecure-unlock"
      - "--verbosity=3"
    deploy:
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  geth-node2:
    image: ethereum/client-go:v1.13.15
    networks:
      - geth-overlay
    ports:
      - "30312:30303/tcp"
      - "30312:30303/udp"
    volumes:
      - /home/vw-srv-0001/services/blockchain/node2/data:/root/.ethereum
      - /home/vw-srv-0001/services/blockchain/node2/password.txt:/root/password.txt:ro
      - /home/vw-srv-0001/services/blockchain/node2/config.toml:/root/config.toml:ro
    command:
      - "--config=/root/config.toml"
      - "--networkid=1234567"
      - "--syncmode=full"
      - "--gcmode=archive"
      - "--port=30303"
      - "--unlock=0x3e72634626da0949e156a6bb201420839ef54703"
      - "--password=/root/password.txt"
      - "--mine"
      - "--miner.etherbase=0x3e72634626da0949e156a6bb201420839ef54703"
      - "--allow-insecure-unlock"
      - "--verbosity=3"
    deploy:
      placement:
        constraints:
          - node.role == worker
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  geth-rpc-node:
    image: ethereum/client-go:v1.13.15
    networks:
      - geth-overlay
    ports:
      - "8545:8545/tcp"
      - "8546:8546/tcp"
      - "30313:30303/tcp"
      - "30313:30303/udp"
    volumes:
      - /home/vw-srv-0001/services/blockchain/node3/data:/root/.ethereum
      - /home/vw-srv-0001/services/blockchain/node3/config.toml:/root/config.toml:ro
    command:
      - "--config=/root/config.toml"
      - "--networkid=1234567"
      - "--syncmode=full"
      - "--gcmode=archive"
      - "--port=30303"
      - "--http"
      - "--http.addr=0.0.0.0"
      - "--http.port=8545"
      - "--http.api=eth,net,web3,txpool,debug,personal"
      - "--http.corsdomain=*"
      - "--http.vhosts=*"
      - "--ws"
      - "--ws.addr=0.0.0.0"
      - "--ws.port=8546"
      - "--ws.api=eth,net,web3,txpool,debug"
      - "--ws.origins=*"
      - "--verbosity=3"
    deploy:
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

# Overlay network for swarm
networks:
  geth-overlay:
    external: true
    attachable: true
